# Руководство по интеграции с маркетплейсами

## Обзор

Система поддерживает автоматическую синхронизацию данных о продажах с маркетплейсами OZON и Wildberries через их API.

## Настройка интеграции

### 1. Получение API ключей

#### OZON
1. Войдите в личный кабинет продавца OZON
2. Перейдите в раздел **Настройки** → **API**
3. Нажмите **Создать ключ**
4. Скопируйте:
   - **Client ID** (идентификатор клиента)
   - **API Key** (ключ API)

#### Wildberries
1. Войдите в личный кабинет продавца Wildberries
2. Перейдите в раздел **Настройки** → **API**
3. Создайте ключ для доступа к API
4. Скопируйте:
   - **API Key** (основной ключ)
   - **Stat API Key** (ключ для статистики, опционально)

### 2. Настройка в системе

1. Откройте раздел **Интеграции** в меню
2. Нажмите **Добавить интеграцию**
3. Выберите:
   - Маркетплейс (OZON или Wildberries)
   - Организацию
4. Введите API ключи:
   - Для OZON: Client ID и API Key
   - Для Wildberries: API Key (и Stat API Key при необходимости)
5. Настройте параметры:
   - **Активна** - включить/выключить интеграцию
   - **Автоматическая синхронизация** - включить автосинхронизацию
   - **Интервал синхронизации** - как часто синхронизировать (в часах)
6. Нажмите **Сохранить**

### 3. Проверка подключения

1. После сохранения нажмите кнопку **Проверить** рядом с интеграцией
2. Если подключение успешно, вы увидите сообщение "Подключение успешно"
3. Если есть ошибка, проверьте правильность API ключей

## Синхронизация данных

### Ручная синхронизация

1. В списке интеграций нажмите кнопку **Синхронизировать**
2. Система автоматически получит данные о продажах за последние 30 дней
3. Данные будут сохранены в модуле **Реализация**

### Автоматическая синхронизация

Если включена автоматическая синхронизация:
- Система будет автоматически получать данные с заданным интервалом
- Можно запустить планировщик синхронизации:

```bash
cd backend
python run_sync_scheduler.py
```

Планировщик будет проверять активные интеграции каждый час и синхронизировать данные при необходимости.

### Запуск планировщика как службы (Windows)

1. Создайте файл `sync_scheduler.bat`:
```batch
@echo off
cd /d C:\Users\User_161\Documents\Projects\fin_a\backend
python run_sync_scheduler.py
```

2. Настройте задачу в Планировщике заданий Windows:
   - Создайте новую задачу
   - Триггер: При запуске компьютера или по расписанию
   - Действие: Запуск программы `sync_scheduler.bat`

## Что синхронизируется

- **Дата продажи**
- **Выручка** (сумма продажи)
- **Количество** товаров
- **Описание** (номер заказа или дата)

Данные автоматически создаются в модуле **Реализация** и привязываются к выбранной организации и маркетплейсу.

## Защита от дублирования

Система автоматически проверяет наличие записей с такими же:
- Дата
- Маркетплейс
- Организация
- Выручка

Дубликаты не создаются.

## Мониторинг

В списке интеграций отображается:
- **Статус** (Активна/Неактивна)
- **Последняя синхронизация** (дата и время)
- **Статус последней синхронизации** (Успешно/Ошибка/В процессе)
- **Ошибки** (если были)

## Устранение проблем

### Ошибка "Не указаны учетные данные"
- Проверьте, что все необходимые поля заполнены
- Для OZON нужны Client ID и API Key
- Для Wildberries нужен API Key

### Ошибка "Ошибка подключения"
- Проверьте правильность API ключей
- Убедитесь, что ключи не истекли
- Проверьте доступность API маркетплейса

### Ошибка "Не удалось получить данные"
- Проверьте, что у API ключа есть права на чтение данных о продажах
- Убедитесь, что за выбранный период есть данные
- Проверьте логи для детальной информации

### Данные не синхронизируются автоматически
- Убедитесь, что включена "Автоматическая синхронизация"
- Проверьте, что планировщик запущен
- Проверьте интервал синхронизации

## Безопасность

- API ключи хранятся в зашифрованном виде в базе данных
- В интерфейсе отображаются только последние 4 символа ключа
- При обновлении ключей старые значения не отображаются

## Ограничения API

### OZON
- Лимит запросов: зависит от тарифа
- Максимальный период: обычно 90 дней
- Рекомендуемый интервал синхронизации: не чаще 1 раза в час

### Wildberries
- Лимит запросов: зависит от тарифа
- Максимальный период: обычно 30 дней
- Рекомендуемый интервал синхронизации: не чаще 1 раза в час

## Поддержка

При возникновении проблем:
1. Проверьте логи планировщика
2. Проверьте статус интеграции в интерфейсе
3. Убедитесь, что API ключи актуальны
4. Проверьте документацию API маркетплейса

